(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function o(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function i(e){if(e.ep)return;e.ep=!0;const t=o(e);fetch(e.href,t)}})();const A=class A{};A.fontset=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];let L=A;var E={exports:{}},Y=E.exports,P;function O(){return P||(P=1,(function(f){(function(s,o){f.exports?f.exports=o():s.log=o()})(Y,function(){var s=function(){},o="undefined",i=typeof window!==o&&typeof window.navigator!==o&&/Trident\/|MSIE /.test(window.navigator.userAgent),e=["trace","debug","info","warn","error"],t={},a=null;function p(h,d){var r=h[d];if(typeof r.bind=="function")return r.bind(h);try{return Function.prototype.bind.call(r,h)}catch{return function(){return Function.prototype.apply.apply(r,[h,arguments])}}}function g(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function V(h){return h==="debug"&&(h="log"),typeof console===o?!1:h==="trace"&&i?g:console[h]!==void 0?p(console,h):console.log!==void 0?p(console,"log"):s}function y(){for(var h=this.getLevel(),d=0;d<e.length;d++){var r=e[d];this[r]=d<h?s:this.methodFactory(r,h,this.name)}if(this.log=this.debug,typeof console===o&&h<this.levels.SILENT)return"No console available for logging"}function w(h){return function(){typeof console!==o&&(y.call(this),this[h].apply(this,arguments))}}function T(h,d,r){return V(h)||w.apply(this,arguments)}function m(h,d){var r=this,b,S,v,u="loglevel";typeof h=="string"?u+=":"+h:typeof h=="symbol"&&(u=void 0);function U(c){var l=(e[c]||"silent").toUpperCase();if(!(typeof window===o||!u)){try{window.localStorage[u]=l;return}catch{}try{window.document.cookie=encodeURIComponent(u)+"="+l+";"}catch{}}}function F(){var c;if(!(typeof window===o||!u)){try{c=window.localStorage[u]}catch{}if(typeof c===o)try{var l=window.document.cookie,C=encodeURIComponent(u),K=l.indexOf(C+"=");K!==-1&&(c=/^([^;]+)/.exec(l.slice(K+C.length+1))[1])}catch{}return r.levels[c]===void 0&&(c=void 0),c}}function B(){if(!(typeof window===o||!u)){try{window.localStorage.removeItem(u)}catch{}try{window.document.cookie=encodeURIComponent(u)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function x(c){var l=c;if(typeof l=="string"&&r.levels[l.toUpperCase()]!==void 0&&(l=r.levels[l.toUpperCase()]),typeof l=="number"&&l>=0&&l<=r.levels.SILENT)return l;throw new TypeError("log.setLevel() called with invalid level: "+c)}r.name=h,r.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},r.methodFactory=d||T,r.getLevel=function(){return v??S??b},r.setLevel=function(c,l){return v=x(c),l!==!1&&U(v),y.call(r)},r.setDefaultLevel=function(c){S=x(c),F()||r.setLevel(c,!1)},r.resetLevel=function(){v=null,B(),y.call(r)},r.enableAll=function(c){r.setLevel(r.levels.TRACE,c)},r.disableAll=function(c){r.setLevel(r.levels.SILENT,c)},r.rebuild=function(){if(a!==r&&(b=x(a.getLevel())),y.call(r),a===r)for(var c in t)t[c].rebuild()},b=x(a?a.getLevel():"WARN");var R=F();R!=null&&(v=x(R)),y.call(r)}a=new m,a.getLogger=function(d){if(typeof d!="symbol"&&typeof d!="string"||d==="")throw new TypeError("You must supply a name when creating a logger.");var r=t[d];return r||(r=t[d]=new m(d,a.methodFactory)),r};var k=typeof window!==o?window.log:void 0;return a.noConflict=function(){return typeof window!==o&&window.log===a&&(window.log=k),a},a.getLoggers=function(){return t},a.default=a,a})})(E)),E.exports}var X=O();const n=X.getLogger("Chip");n.setLevel("warn");class M{constructor(){this.audio=null,this.memory=new Uint8Array(4096),this.V=new Uint8Array(16),this.I=0,this.pc=512,this.stack=new Uint16Array(16),this.stackPointer=0,this.delay_timer=0,this.sound_timer=0,this.keys=new Uint8Array(16),this.frameBuffer=new Uint8Array(2048),this.needRedraw=!1,this.loadFontset()}linkAudio(s){this.audio=s}run(){const s=this.memory[this.pc],o=this.memory[this.pc+1];if(s===void 0||o===void 0)throw new Error(`Memory read out of bounds at PC=${this.pc.toString(16).toUpperCase()}`);const i=s<<8|o;switch(n.info(i.toString(16).toUpperCase()+": "),i&61440){case 0:{switch(i&4095){case 224:{for(let e=0;e<this.frameBuffer.length;e++)this.frameBuffer[e]=0;this.needRedraw=!0,this.pc+=2,n.info("00E0 Clears the screen");break}case 238:{this.stackPointer--;const e=this.stack[this.stackPointer];if(e===void 0)throw new Error("Stack underflow: no return address");this.pc=e+2,n.info("00EE Returning to "+this.pc.toString(16).toUpperCase());break}default:console.error("0NNN Unsupported Opcode!")}break}case 4096:{const e=i&4095;this.pc=e,n.info("1NNN Jumps to address "+this.pc.toString(16).toUpperCase());break}case 8192:{this.stack[this.stackPointer]=this.pc,this.stackPointer+=1,this.pc=i&4095,n.info("2NNN Calls subroutine at "+this.pc.toString(16).toUpperCase());break}case 12288:{const e=(i&3840)>>8,t=i&255;this.V[e]===t?(this.pc+=4,n.info("3XNN Skipping next instruction if (V["+e+"] == "+t+")")):(this.pc+=2,n.info("3XNN Not skipping next instruction if (V["+e+"] != "+t+")"));break}case 16384:{const e=(i&3840)>>8,t=i&255;this.V[e]!==t?(this.pc+=4,n.info("4XNN Skipping next instruction if (V["+e+"] != "+t+")")):(this.pc+=2,n.info("4XNN Not Skipping next instruction if (V["+e+"] == "+t+")"));break}case 20480:{const e=(i&3840)>>8,t=(i&240)>>4;this.V[e]===this.V[t]?(this.pc+=4,n.info("5XY0 Skipping next instruction (V["+e+"] == V["+t+"])")):this.pc+=2;break}case 24576:{const e=(i&3840)>>8,t=i&255;this.V[e]=t,this.pc+=2,n.info("6XNN Sets V["+e+"] to NN = "+t);break}case 28672:{const e=(i&3840)>>8,t=i&255;this.V[e]=(this.V[e]??0)+t&255,this.pc+=2,n.info("7XNN Adding "+t+" to V["+e+"] = "+this.V[e]);break}case 32768:{switch(i&15){case 0:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");this.V[e]=this.V[t],this.pc+=2,n.info("8XY0 Set V["+e+"] to the value of V["+t+"] = "+this.V[e]);break}case 1:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");if(this.V[e]===void 0||this.V[t]===void 0)throw new Error("V[x] or V[y] is undefined");this.V[e]=this.V[e]|this.V[t],this.pc+=2,n.info("8XY1 Set V["+e+"] to V["+e+"] | V["+t+"]= "+this.V[e]);break}case 2:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");if(this.V[e]===void 0||this.V[t]===void 0)throw new Error("V[x] or V[y] is undefined");this.V[e]=this.V[e]&this.V[t],this.pc+=2,n.info("8XY2 Set V["+e+"] to V["+e+"] & V["+t+"]= "+this.V[e]);break}case 3:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");if(this.V[e]===void 0||this.V[t]===void 0)throw new Error("V[x] or V[y] is undefined");this.V[e]=this.V[e]^this.V[t],this.pc+=2,n.info("8XY3 Set V["+e+"] to V["+e+"] ^ V["+t+"]= "+this.V[e]);break}case 4:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");if(this.V[e]===void 0||this.V[t]===void 0)throw new Error("V[x] or V[y] is undefined");this.V[t]>255-this.V[e]?(this.V[15]=1,n.info("8XY4 Carry!")):(this.V[15]=0,n.info("8XY4 No Carry")),this.V[e]=this.V[e]+this.V[t]&255,this.pc+=2,n.info("8XY4 Set V["+e+"] to V["+e+"] + V["+t+"]= "+this.V[e]);break}case 5:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");if(this.V[e]===void 0||this.V[t]===void 0)throw new Error("V[x] or V[y] is undefined");this.V[e]>this.V[t]?(this.V[15]=1,n.info("8XY5 No Borrow")):(this.V[15]=0,n.info("8XY5 Borrow")),this.V[e]=this.V[e]-this.V[t]&255,this.pc+=2,n.info("8XY5 Set V["+e+"] to V["+e+"] - V["+t+"]= "+this.V[e]);break}case 6:{const e=(i&3840)>>8;if(this.V[e]===void 0)throw new Error("V[x] is undefined");this.V[15]=this.V[e]&1,this.V[e]=this.V[e]>>1,this.pc+=2,n.info("8XY6 Shifts V["+e+"] to the right by 1");break}case 7:{const e=(i&3840)>>8,t=(i&240)>>4;if(this.V[t]===void 0)throw new Error("V[y] is undefined");if(this.V[e]===void 0||this.V[t]===void 0)throw new Error("V[x] or V[y] is undefined");this.V[t]>this.V[e]?this.V[15]=1:this.V[15]=0,this.V[e]=this.V[t]-this.V[e],this.pc+=2,n.info("8XY7 Sets V["+e+"] to V["+t+"] - V["+e+"] = "+this.V[e]);break}default:throw new Error("Unsupported Opcode! 0x8000")}break}case 36864:{switch(i&15){case 0:{const e=(i&3840)>>8,t=(i&240)>>4;this.V[e]!==this.V[t]?this.pc+=4:this.pc+=2,n.info("9XY0 Skips the next instruction if VX does not equal VY.");break}default:throw new Error("Unsupported Opcode! 0x9000")}break}case 40960:{this.I=i&4095,this.pc+=2,n.info("ANNN Set I to "+this.I.toString(16).toUpperCase());break}case 45056:{this.stack[this.stackPointer]=this.pc,this.stackPointer+=1;const e=i&4095;if(this.V[0]===void 0)throw new Error("V[0] is undefined");this.pc=this.V[0]+e&4095,console.error("BNNN Jumps to the address NNN plus V[0] = "+this.pc);break}case 49152:{const e=(i&3840)>>8,t=i&255,a=Math.floor(Math.random()*256)&t;this.V[e]=a,this.pc+=2,n.info("CXNN Sets V["+e+"] to the result of a bitwise and operation on a random number");break}case 53248:{const e=(i&3840)>>8,t=this.V[e],a=(i&240)>>4,p=this.V[a],g=i&15;this.V[15]=0;for(let V=0;V<g;V++){const y=this.memory[this.I+V];for(let w=0;w<8;w++){if(y===void 0)throw new Error("line is undefined");if((y&128>>w)!==0){if(t===void 0)throw new Error("vxd is undefined");let m=(t??0)+w,k=(p??0)+V;m=m%64,k=k%32;const h=k*64+m;this.frameBuffer[h]===1&&(this.V[15]=1),this.frameBuffer[h]!==void 0&&(this.frameBuffer[h]^=1)}}}this.pc+=2,this.needRedraw=!0,n.info("DXYN Draws a sprite at coordinate ("+t+","+p+")");break}case 57344:{switch(i&255){case 158:{const e=(i&3840)>>8,t=this.V[e]??0;this.keys[t]===1?(this.pc+=4,n.info("ENNN Skips the next instruction if the key stored in V["+e+"] is pressed")):this.pc+=2;break}case 161:{const e=(i&3840)>>8,t=this.V[e]??0;this.keys[t]===0?(this.pc+=4,n.info("EXA1 Skips the next instruction if the key stored in V["+e+"] is not pressed")):this.pc+=2;break}default:throw new Error("Unexisting Opcode!")}break}case 61440:{switch(i&255){case 7:{const e=(i&3840)>>8;this.V[e]=this.delay_timer&255,this.pc+=2,n.info("FX07 Sets V["+e+"] "+this.V[e]+" to the value of the delay timer.");break}case 10:{const e=(i&3840)>>8;for(let t=0;t<this.keys.length;t++)if(this.keys[t]===1){this.V[e]=t,this.pc+=2;break}n.info("FX0A Awaiting a key pressed store to V["+e+"]");break}case 21:{const e=(i&3840)>>8;this.delay_timer=(this.V[e]??0)&255,this.pc+=2,n.info("FX15 Sets the delay timer to V["+e+"] = "+this.V[e]);break}case 24:{const e=(i&3840)>>8;this.sound_timer=1,this.pc+=2,n.info("FX18 Sets the sound timer to VX."+this.V[e]);break}case 41:{const e=(i&3840)>>8,t=this.V[e];this.I=80+(t??0)*5,this.pc+=2,n.info("FX29 Setting I to Character V["+e+"] = "+this.V[e]+" Offset to 0x"+this.I.toString(16).toUpperCase());break}case 30:{const e=(i&3840)>>8;this.I=this.I+this.V[e],this.pc+=2;break}case 51:{const e=(i&3840)>>8,t=this.V[e],a=Math.floor((t??0)/100),p=Math.floor((t??0)%100/10),g=(t??0)%10;this.memory[this.I]=a,this.memory[this.I+1]=p,this.memory[this.I+2]=g,this.pc+=2,n.info("FX33 Stores the binary-coded decimal representation of V["+e+"]: "+a+p+g);break}case 85:{const e=(i&3840)>>8;for(let t=0;t<=e;t++)this.memory[this.I+t]=this.V[t];this.pc+=2,n.info("FX55 Stores from V0 to VX (including VX) in memory, starting at address I.");break}case 101:{const e=(i&3840)>>8;for(let t=0;t<=e;t++)this.V[t]=this.memory[this.I+t];this.I=this.I+e+1,this.pc+=2,n.info("FX65 Fills from V[0] to V["+e+"] with values from memory[0x"+(this.I&255).toString(16).toUpperCase()+"]");break}default:throw new Error("Unsupported Opcode!")}break}default:throw new Error("Unsupported Opcode!")}this.sound_timer>0&&(this.sound_timer--,this.audio?.playSound()),this.delay_timer>0&&this.delay_timer--}getFrameBuffer(){return this.frameBuffer}isNeedRedraw(){return this.needRedraw}removeDrawFlag(){this.needRedraw=!1}async loadProgram(s){try{const i=await(await fetch(s)).arrayBuffer(),e=new Uint8Array(i);for(let t=0;t<e.length;t++)this.memory[512+t]=e[t]}catch(o){throw console.error("Error loading program:",o),o}}loadFontset(){for(let s=0;s<L.fontset.length;s++)this.memory[80+s]=L.fontset[s]}setKeyBuffer(s){for(let o=0;o<this.keys.length;o++)this.keys[o]=s[o]}setKey(s,o){s>=0&&s<16&&(this.keys[s]=o?1:0)}getPC(){return this.pc}getRegisters(){return this.V}getI(){return this.I}}class _{constructor(){this.audioContext=null,this.oscillator=null,typeof window<"u"&&(this.audioContext=new(window.AudioContext||window.webkitAudioContext))}playSound(s=800,o=200){if(!this.audioContext){console.warn("AudioContext is not available");return}try{this.oscillator=this.audioContext.createOscillator();const i=this.audioContext.createGain();this.oscillator.type="sine",this.oscillator.frequency.setValueAtTime(s,this.audioContext.currentTime),i.gain.setValueAtTime(.3,this.audioContext.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+o/1e3),this.oscillator.connect(i),i.connect(this.audioContext.destination),this.oscillator.start(),this.oscillator.stop(this.audioContext.currentTime+o/1e3),this.oscillator.onended=()=>{this.oscillator=null}}catch(i){console.error("Error playing sound:",i)}}stopSound(){this.oscillator&&(this.oscillator.stop(),this.oscillator=null)}close(){this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.close()}}const I=X.getLogger("Keyboard");I.setLevel("warn");class z{constructor(s){this.container=s,this.keyPanel=this.createKeyboardPanel(),this.container.appendChild(this.keyPanel),this.keyBuffer=new Array(16).fill(0),this.keyIdToKey=new Array(256).fill(-1),this.fillKeyIds(),this.listenPanelClick()}listenPanelClick(){const s=(o,i)=>{const e=o.target;if(e.classList.contains("key")){const t=Number(e.dataset.value);I.debug("[keyboard] panel click",t,i),this.keyBuffer[t]=i,this.updateRender()}};this.keyPanel.addEventListener("mousedown",o=>s(o,1)),this.keyPanel.addEventListener("mouseout",o=>s(o,0))}createKeyboardPanel(){const s=document.createElement("div");return s.classList.add("keyboard-panel"),[["1","2","3","C"],["4","5","6","D"],["7","8","9","E"],["A","0","B","F"]].forEach(i=>{const e=document.createElement("div");e.classList.add("row"),i.forEach(t=>{const a=document.createElement("div");a.innerText=t,a.dataset.value=`0x${t}`,a.classList.add("key"),e.appendChild(a)}),s.appendChild(e)}),s}updateRender(){const s=this.keyPanel.getElementsByClassName("key"),o=new Map;this.keyBuffer.forEach((i,e)=>{o.set(e,i)}),Array.from(s).forEach(i=>{const e=i.dataset.value;o.get(Number(e))===1?i.classList.add("key-down"):i.classList.remove("key-down")})}fillKeyIds(){for(let s=0;s<this.keyIdToKey.length;s++)this.keyIdToKey[s]=-1;this.keyIdToKey[49]=1,this.keyIdToKey[50]=2,this.keyIdToKey[51]=3,this.keyIdToKey[52]=12,this.keyIdToKey[81]=4,this.keyIdToKey[87]=5,this.keyIdToKey[69]=6,this.keyIdToKey[82]=13,this.keyIdToKey[65]=7,this.keyIdToKey[83]=8,this.keyIdToKey[68]=9,this.keyIdToKey[70]=14,this.keyIdToKey[90]=10,this.keyIdToKey[88]=0,this.keyIdToKey[67]=11,this.keyIdToKey[86]=15}keyPressed(s){const o=this.keyIdToKey[s];I.debug(`keyPressed: ${s} -> ${o}`),o!==-1&&(this.keyBuffer[o]=1),this.updateRender()}keyReleased(s){const o=this.keyIdToKey[s];o!==-1&&(this.keyBuffer[o]=0),this.updateRender()}getKeyBuffer(){return this.keyBuffer}getKeyState(s){return s>=0&&s<this.keyBuffer.length?this.keyBuffer[s]:0}clearKeyBuffer(){for(let s=0;s<this.keyBuffer.length;s++)this.keyBuffer[s]=0}bindToElement(s){I.debug("bindToElement",s),s.addEventListener("keydown",o=>{this.keyPressed(o.keyCode||o.which)}),s.addEventListener("keyup",o=>{this.keyReleased(o.keyCode||o.which)})}unbindFromElement(s){s.removeEventListener("keydown",()=>{}),s.removeEventListener("keyup",()=>{})}}class D{constructor(s){this.pixelSize=10,this.width=64,this.height=32,this.container=s,this.canvas=document.createElement("canvas"),this.canvas.width=this.width*this.pixelSize,this.canvas.height=this.height*this.pixelSize,this.container.appendChild(this.canvas),this.canvas.tabIndex=0,this.canvas.focus(),this.ctx=this.canvas.getContext("2d")}render(s){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let o=0;o<s.length;o++){s[o]===0?this.ctx.fillStyle="#000000":this.ctx.fillStyle="#FFFFFF";const i=o%this.width*this.pixelSize,e=Math.floor(o/this.width)*this.pixelSize;this.ctx.fillRect(i,e,this.pixelSize,this.pixelSize)}}dispose(){this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}function N(f=0){return f.toString(16).padStart(2,"0").toUpperCase()}class q{constructor(s){this.container=document.createElement("div"),this.$fps=document.createElement("div"),this.$reg=document.createElement("div"),this.$pc=document.createElement("div"),this.frames=[],this.chip8=s,this.$fps.classList.add("fps"),this.$reg.classList.add("reg"),this.$pc.classList.add("pc"),this.container.classList.add("debug-container"),this.container.appendChild(this.$fps),this.container.appendChild(this.$reg),this.container.appendChild(this.$pc),this.update()}record(){this.frames.push(Date.now()),this.frames.length>100&&this.frames.shift();const s=this.frames[0],o=this.frames[this.frames.length-1],i=this.frames.length/(o-s)*1e3;this.$fps.innerText=`FPS: ${i.toFixed(0)}`}updateRegister(){const s=this.chip8.getRegisters(),o=Array.from(s).map(i=>N(i)).join(" ");this.$reg.innerText=`REG: ${o}`}updatePC(){const s=N(this.chip8.getPC()>>8),o=N(this.chip8.getPC()&255);this.$pc.innerText=`PC : ${s} ${o}`}update(){this.record(),this.updateRegister(),this.updatePC()}}class W{constructor(s){this.isRunning=!1;const o=document.createElement("div");o.classList.add("c8-head");const i=document.createElement("div");i.classList.add("c8-body");const e=document.createElement("div");e.classList.add("screen-container");const t=document.createElement("div");t.classList.add("keyboard-container"),i.appendChild(e),i.appendChild(t),this.container=document.createElement("div"),this.container.classList.add("c8-container"),this.container.appendChild(o),this.container.appendChild(i),s.appendChild(this.container),this.keyboard=new z(t),this.keyboard.bindToElement(document.documentElement),this.screen=new D(e),this.audio=new _,this.chip8=new M,this.chip8.linkAudio(this.audio),this.chip8.loadProgram("./programs/pong2.c8"),this.debugUI=new q(this.chip8),o.appendChild(this.debugUI.container)}async run(){for(this.isRunning=!0;this.isRunning;)this.chip8.setKeyBuffer(this.keyboard.getKeyBuffer()),this.chip8.run(),this.chip8.isNeedRedraw()&&(this.screen.render(this.chip8.getFrameBuffer()),this.chip8.removeDrawFlag(),this.debugUI.update()),await this.sleep(8)}stop(){this.isRunning=!1}dispose(){this.stop(),this.screen.dispose(),this.keyboard.unbindFromElement(document.documentElement)}sleep(s){return new Promise(o=>setTimeout(o,s))}}window.addEventListener("load",()=>{const f=document.getElementById("app");f&&new W(f).run().catch(console.error)});
